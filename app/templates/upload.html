{% extends "base.html" %}

{% block app_content %}
    <div>
        <div class="alert alert-danger" style="display: none" role="alert"></div>
        <div class="alert alert-success" style="display: none" role="alert"></div>
    </div>
    <h1>File Upload</h1>
    <div class="row">
        <div class="col-md-8">
            <div class="progress" style="display: none">
              <div id="progressBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                   aria-valuemax="100" style="min-width: 2em;">
                0%
              </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <form method="post" enctype="multipart/form-data" action="/upload">
                <p>
                    {{ form.hidden_tag() }}
                    {{ form.file.label }}<br>
                    {{ form.file }}<br>
                    {% for error in form.file.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                </p>
                <!--<button id="upload-file-btn" type="button">Upload</button>-->
                <input type="submit">
            </form>
        </div>
    </div>
    <br/>
    <div class="row">
        <div class="col-md-8">
            <h5><strong>Acceptable file formats: .txt, .gzip and .zip</strong></h5>
            <h5>Special requirements for the <strong>.TXT</strong> file:</h5>
            <ul>
                <li>
                    .TXT file maximum upload size limit: <span class="label label-success">100MB</span>
                </li>
                <li> File mandatory columns must be separated by <span class="label label-default">
                    <strong>[TAB]</strong></span> and below orders and types.
                    No column title/name needed.
                    There must be only list of values separated by
                    <span class="label label-default"><strong>[TAB]</strong></span>.
                    <table border="1" style="margin:5px;">
                        <!--<tr>-->
                            <!--<td style="padding:5px;" colspan="{{ formats | length }}">File mandatory columns order and types</td>-->
                        <!--</tr>-->
                        <tr>
                            {% for format in formats %}
                            <td style="padding:5px;" > {{ format.title}}(type:{{ format.col_type}}) </td>
                            {% endfor %}
                        </tr>
                    </table>
                </li>
            </ul>
        </div>
    </div>

{% endblock %}


{% block scripts %}
{{ super() }}
    <script>
        $(document).ready(function () {
           $(function() {
                // $('#upload-file').on('submit', function() {
               $('form').on('submit', function(event) {
                    event.preventDefault();

                    $('#progressBar').attr('aria-valuenow', 0).css('width', '0%').text('0%');
                    $('.progress').show();
                    $('.alert-danger').hide();
                    $('.alert-success').hide();

                    //var form_data = new FormData($('form')[0]);
                    var form_data = new FormData($('form')[0]);
                    $.ajax({
                        xhr: function(){
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener('progress', function(e){
                               if(e.lengthComputable){
                                   console.log('Bytes Loaded: ' + e.loaded);
                                   console.log('Total size: ' + e.total);
                                   console.log('Percentage uploaded: ' + (e.loaded / e.total));

                                   var percent = Math.round((e.loaded / e.total) * 100);

                                   $('#progressBar').attr('aria-valuenow', percent).css('width', percent + '%').text(percent + '%');
                               }
                            });
                            return xhr;
                        },
                        type: 'POST',
                        url: '/upload',
                        data: form_data,
                        contentType: false,
                        // cache: false,
                        processData: false,
                        // async: false,
                        success: function(data) {
                            if(data[1] == 200) {
                                $('.alert-success').text(data[0].message);
                                $('.alert-success').show();
                            }else{
                                $('.progress').hide();
                                $('.alert-danger').text(data[0].message);
                                $('.alert-danger').show();
                            }
                            console.log(data);
                        },error: function(jqXHR, status, err){
                             console.log(status);
                            $('.alert-danger').text(err.toLowerCase()+'!');
                            $('.alert-danger').show();
                        }
                    });
                });
            });
       });
    </script>
{% endblock %}